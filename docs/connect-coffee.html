<!DOCTYPE html>  <html> <head>   <title>connect-coffee.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               connect-coffee.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>connect-coffee (c) 2011 Trevor Burnham.</strong> connect-coffee is based
on the staticProvider module of Connect by Sencha Inc., and is freely
distributable under the terms of the <a href="http://www.opensource.org/licenses/mit-license.php">MIT
license</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">CoffeeScript = </span><span class="nx">require</span> <span class="s1">&#39;coffee-script&#39;</span>
<span class="nv">fs = </span><span class="nx">require</span> <span class="s1">&#39;fs&#39;</span>
<span class="nv">parseUrl = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">).</span><span class="nx">parse</span>
<span class="nv">path = </span><span class="nx">require</span> <span class="s1">&#39;path&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Map of request URLs to stored JavaScripts</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">cache = </span><span class="p">{}</span>

<span class="nv">module.exports = </span><span class="p">(</span><span class="nv">root = </span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">())</span> <span class="o">-&gt;</span>

  <span class="nf">(req, res, next) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;req.url = #{req.url}&quot;</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">is</span> <span class="s1">&#39;GET&#39;</span> <span class="o">or</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">is</span> <span class="s1">&#39;HEAD&#39;</span>
    <span class="nv">head = </span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">is</span> <span class="s1">&#39;HEAD&#39;</span>
    <span class="nv">url = </span><span class="nx">parseUrl</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span>
    <span class="nv">filename = </span><span class="nb">decodeURIComponent</span> <span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span>
    <span class="k">return</span> <span class="nx">forbidden</span> <span class="nx">res</span> <span class="k">if</span> <span class="o">~</span><span class="nx">filename</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s1">&#39;..&#39;</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">filename</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/\.js/</span>
    <span class="nv">filename = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">filename</span><span class="p">).</span><span class="nx">replace</span> <span class="sr">/\.js$/</span><span class="p">,</span> <span class="s1">&#39;.coffee&#39;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;filename = #{filename}&quot;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Check the cache</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">!</span><span class="nx">conditionalGET</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nv">hit = </span><span class="nx">cache</span><span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">])</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">headers</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="p">(</span><span class="k">if</span> <span class="nx">head</span> <span class="k">then</span> <span class="kc">undefined</span> <span class="k">else</span> <span class="nx">hit</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
      <span class="k">return</span>
    </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Find out if a corresponding CoffeeScript file exists</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">filename</span><span class="p">,</span> <span class="nf">(err, stat) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="k">return</span> <span class="k">if</span> <span class="nx">err</span><span class="p">.</span><span class="nx">errno</span> <span class="o">is</span> <span class="nx">process</span><span class="p">.</span><span class="nx">ENOENT</span> <span class="k">then</span> <span class="nx">next</span><span class="p">()</span> <span class="k">else</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">()</span>
      
      <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">filename</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="nf">(err, data) -&gt;</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">if</span> <span class="nx">err</span>
        
        <span class="nv">compilerOptions = </span><span class="p">{}</span>
        <span class="k">try</span>
          <span class="nv">js = </span><span class="nx">CoffeeScript</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">compilerOptions</span>
        <span class="k">catch</span> <span class="nx">compileErr</span>
          <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">compileErr</span><span class="p">)</span>

        <span class="nv">headers =</span>
          <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/javascript&#39;</span>
          <span class="s1">&#39;Content-Length&#39;</span><span class="o">:</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span> <span class="nx">js</span>
          <span class="s1">&#39;Last-Modified&#39;</span><span class="o">:</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">toUTCString</span><span class="p">()</span>
          <span class="s1">&#39;Cache-Control&#39;</span><span class="o">:</span> <span class="s2">&quot;public max-age=0&quot;</span>
          <span class="s1">&#39;ETag&#39;</span><span class="o">:</span> <span class="nx">etag</span> <span class="nx">stat</span>
      
        <span class="k">return</span> <span class="nx">notModified</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">headers</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">modified</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">headers</span>
      
        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="nx">headers</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="p">(</span><span class="k">if</span> <span class="nx">head</span> <span class="k">then</span> <span class="kc">undefined</span> <span class="k">else</span> <span class="nx">js</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Given the request and the headers we intend to send, has the file been modified
since the requester last received it?</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">modified = </span><span class="nf">(req, headers) -&gt;</span>
  <span class="nv">modifiedSince = </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;if-modified-since&#39;</span><span class="p">]</span>
  <span class="nv">lastModified = </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Last-Modified&#39;</span><span class="p">]</span>
  <span class="nv">noneMatch = </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;if-none-match&#39;</span><span class="p">]</span>
  <span class="nv">etag = </span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;ETag&#39;</span><span class="p">]</span>
  
  <span class="k">if</span> <span class="nx">noneMatch</span> <span class="o">and</span> <span class="p">(</span><span class="nx">noneMatch</span> <span class="o">is</span> <span class="nx">etag</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">false</span>
  
  <span class="k">if</span> <span class="nx">modifiedSince</span> <span class="o">and</span> <span class="nx">lastModified</span>
    <span class="nv">modifiedSinceDate = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">modifiedSince</span><span class="p">)</span>
    <span class="nv">lastModifiedDate = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">lastModified</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">modifiedSinceDate</span><span class="p">.</span><span class="nx">getTime</span><span class="p">())</span>
      <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">lastModifiedDate</span> <span class="o">&lt;=</span> <span class="nx">modifiedSince</span>
  
  <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Checks if <code>req</code> is a conditional GET request</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">conditionalGET = </span><span class="nf">(req) -&gt;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;if-modified-since&#39;</span><span class="p">]</span> <span class="o">or</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;if-none-match&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Returns an etag of the form size-mtime</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">etag = </span><span class="nf">(stat) -&gt;</span> <span class="s2">&quot;#{stat.size}-#{Number(stat.mtime)}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Sends a 304 response</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">notModified = </span><span class="nf">(res, headers) -&gt;</span>
  <span class="k">for</span> <span class="nx">field</span> <span class="k">of</span> <span class="nx">headers</span> <span class="k">when</span> <span class="nx">field</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s1">&#39;Content&#39;</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="k">delete</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">304</span><span class="p">,</span> <span class="nx">headers</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
  <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Sends a 403 error</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">forbidden = </span><span class="nf">(res) -&gt;</span>
  <span class="nv">body = </span><span class="s1">&#39;Forbidden&#39;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">403</span><span class="p">,</span>
    <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span>
    <span class="s1">&#39;Content-Length&#39;</span><span class="o">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">length</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="nx">body</span>
  <span class="k">return</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 